<html>
<head>
	<link type="text/css" href="css/maslo-theme/jquery-ui-1.8.16.custom.css" rel="stylesheet" /> 
	<link type="text/css" href="css/jquery.cleditor.css" rel="stylesheet" />
	<link type="text/css" href="css/foundation.css" rel="stylesheet" />
	<link type="text/css" href="css/screen.css" rel="stylesheet" />
	<title>MASLO - Edit Project</title>
</head>
<body>
	<header>
	<h3><a href="index.html">My Content Packs</a> > <span id="proj"></span></h3>
	<div class="extra"><a href="#" onclick="help()">Help</a><img src="icons/maslo_icon_logo.png" /></div>
	</header>
	<table>
	<thead>
		<tr>
			<th>Type</th>
			<th class="big">Title</th>
			<th class="big">Status</th>
			<th>Remove</th>
		</tr>
	</thead>
	<tbody class="proj">
	</tbody>
</table>
<div class="action">
	<a class="alt nice small radius blue button" href="">+ Add Content</a>
	<div class="alt">
		<input type="text" length="10" />
		<button type="button">OK</button>
		<button type="button" class="cancel">Cancel</button>
	</div>
	<button type="button" class="nice small radius blue button">Publish</button>
	<button type="button" class="nice small radius blue button" id="preview">Preview</button>
	<div class="clear"></div>
</div>

<!------------------- DIALOGS --------------------- -->

<div id="dialog-add" style="display: none" title="Add Content">
	<table>
		<tbody>
			<tr>
				<td><input type="file" id="upload" style="display: none" />
					<!-- this button sends any click to the hidden
					     file input element -->
					<button class="alt nice small radius blue button" onclick="$('#upload').click()">Upload</button></td>
				<td>
					<img src="icons/image.png" height="16" width="16"/>
					Image:&nbsp;png,&nbsp;jpg,&nbsp;gif,&nbsp;tiff<br />
					<img src="icons/audio.png" height="16" width="16"/>
					Audio:&nbsp;mp3,&nbsp;wav,&nbsp;aiff<br />
					<img src="icons/video.png" height="16" width="16"/>
					Video:&nbsp;mp4,&nbsp;avi,&nbsp;mov
				</td>
			</tr>
			<tr>
				<td><button class="alt nice small radius blue button" id="btnCreate" type="button">Create Text</button></td>
				<td>
					<img src="icons/text.png" height="16" width="16"/>
					Write new, or copy and paste
				</td>
			</tr>
			<tr>
				<td><button class="alt nice small radius blue button" id="btnQuiz" type="button">Create Quiz</button></td>
				<td>
					<img src="icons/quiz.png" height="16" width="16"/>
					Questions, answer, hints
				</td>
			</tr>
		</tbody>
	</table>
	<form class="quiz" style="display:none" action="quiz.html" method="GET">
		<input type="text" name="name" />
		<input type="submit" value="Create" disabled="disabled" />
	</form>
</div>

<div id="dialog-content" style="display: none" title="Edit Content">
	<input type="text" size="55" class="title" />
	<div></div>
</div>

<div id="dialog-confirm" style="display: none" title="Delete Content">
	<p>This content will be permanently deleted and cannot be
	recovered. Are you sure?</p>
</div>

</body>

<script type="text/javascript" src="AIRAliases.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.watermark.min.js"></script>
<script type="text/javascript" src="js/jquery.cleditor.js"></script>
<script type="text/javascript" src="js/mpthrize.js"></script>
<script type="text/javascript" src="js/param.js"></script>
<script type="text/javascript" src="js/files.js"></script>
<script type="text/javascript" src="js/urldecode.js"></script>
<script type="text/javascript" src="js/manifest.js"></script>
<script type="text/javascript" src="js/help.js"></script>
<script type="text/javascript">
var gPageParams = queryParameters(document.location.search);
var	gManifest = manifest(gPageParams.name);

// This function is called when the dialog-content is closed, and
// is used to stop audio in the case of audio content which is still
// playing when the dialog is closed.
var gCloseDlgHandler = function() {};

// -------------------------- SET UP PAGE -------------------------
$(document).ready(function() {
	$('#proj').text(gPageParams.name.toString());

	for(var m in gManifest) {
		m = gManifest[m];
		appendItemToList(m, $('tbody.proj'));
	}
	linkManifestOrderToTable(gManifest, $('tbody.proj'), gPageParams.name);

// -------------------------- REGISTER LINK CLICKS -------------------------
	function activateRemoveLinks(link) {
		link.click(function(e) {
			var elt = $(this).parent().parent();
			$( "#dialog-confirm" ).dialog({
				height:240,
				modal: true,
				buttons: {
					"Delete Content": function() {
						gManifest.splice(elt.index(), 1);
						var condemned = new air.File(
							elt.find('a').attr('href')
						);
						if(condemned.isDirectory) {
							condemned.deleteDirectory(true);
						} else {
							condemned.deleteFile();
						}
						saveManifest(gManifest, gPageParams.name);
						elt.remove();
						$( this ).dialog( "close" );
					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				}
			});
		});
	}
	activateRemoveLinks($('img.remove'));

	$('form.quiz input[type="text"]').watermark('Name of Quiz');
	$('form.quiz input[type="text"]').keyup(function() {
		$('form.quiz input[type="submit"]').attr('disabled', $(this).val() == '');
	});

	function activateItemLinks(link) {
		link.click(function(e) {
			var elt = $(e.target).parent().parent();
			var pos = elt.index();
			$('#dialog-content input.title').val($(e.target).text());
			var contentDiv = $('#dialog-content div');

			// first set up the dialog-content dialog
			var textArea = $('<textarea rows="3" cols="50"></textarea>');

			if(e.target.rel == 'text') {
				textArea.val(loadTextfile($(e.target).attr('href')));
				contentDiv.append(textArea);
			} else if(e.target.rel == 'image') {
				var img = $('<img />')
				img.attr('src', 'file://' + $(e.target).attr('href'));
				contentDiv.append(img);
				textArea.val(gManifest[pos].description);
				textArea.addClass('description');
				contentDiv.append(textArea);
			} else if(e.target.rel == 'audio') {
				// mpthrize returns a STOP AUDIO function
				gCloseDlgHandler = mpthrize(
					contentDiv, 'file://' + $(e.target).attr('href'))
				textArea.val(gManifest[pos].description);
				textArea.addClass('description');
				contentDiv.append(textArea);
			} else if(e.target.rel == 'quiz') {
				window.location = 'quiz.html?name=' +
					relativize($(e.target).attr('href'));
				return false;
			} else if(e.target.rel == 'video') {
				textArea.addClass('description');
				var options = new air.NativeWindowInitOptions(); 
				options.systemChrome = air.NativeWindowSystemChrome.STANDARD; 
				options.transparent = false; 
				var newWindow = new air.NativeWindow(options);
				newWindow.activate();
				var nc = new air.NetConnection()
				nc.connect(null);
				var ns = new air.NetStream(nc);
				ns.addEventListener(air.AsyncErrorEvent.ASYNC_ERROR, asyncError);
				function asyncError() { }
				ns.play('file://' + $(e.target).attr('href'));
				var vid = new air.Video();
				vid.attachNetStream(ns);
				newWindow.stage.addChild(vid);
			}

			// now show the dialog
			$('#dialog-content').dialog({
				autoOpen: true,
				modal: true,
				width: 540,
				position: 'top',
				beforeClose: function() {
					// when the edit content dialog is closed, clean it for the
					// next time, which may be a very different kind of content
					$('#dialog-content div').empty();
					gCloseDlgHandler();
				},
				buttons: {
					"Replace": function() { 
						var orig = new air.File($(e.target).attr('href'));
						chooseFile(function(f) {
						f.target.copyTo(orig, true);
						d = new Date();
						// reload image with cache-busting querystring
						$('#dialog-content img')
							.attr('src', 'file://' + $(e.target).attr('href') +
								  '?' + d.getTime());
						});
					},
					"Save": function() { 
						if(e.target.rel == 'text') {
							var f = new air.File($(e.target).attr('href'));
							var fs = new air.FileStream();
							fs.open(f, air.FileMode.WRITE);
							fs.writeMultiByte($('#dialog-content textarea').val(), "utf-8");
							fs.close();
						}
						var title = $('#dialog-content input.title').val();
						var desc = $('#dialog-content textarea.description').val();
						var modified = false;
						// update the visible TOC with new title
						// e.target is the link that clicks
						$(e.target).text(title);
						if(gManifest[pos].title != title ||
						   gManifest[pos].description != desc) {
							gManifest[pos].title = title;
							gManifest[pos].description = desc;
							modified = true;
						}
						$(this).dialog("close"); 
						if(modified) {
							saveManifest(gManifest, gPageParams.name);
						}
					} 
				}
			});
			textArea.cleditor({
				controls: "bold italic underline bullets numbering alignleft " +
						  "center alignright justify undo redo cut copy paste"
			});

			return false;
		});
	} // end activeItemLinks

// -------------------------- REGISTER BUTTON CLICKS -------------------------
	$('#preview').click(function() {
		window.location = 'preview.html?name=' + gPageParams.name;
	});
	$('.action a.alt').click(function() {
		$('#dialog-add').dialog({
			autoOpen: true,
			modal: true,
			width: 450,
			position: 'top',
			buttons: {
				"Cancel": function() { 
					$(this).dialog("close"); 
				} 
			}
		});
		return false;
	});

	$('#upload').click(function() {
		chooseFile(function(e) {
			// we use a forward slash here rather than the native path separator
			// because it occurs in the url form of the filename
			var end = urldecode(e.target.url).slice(
				1 + e.target.url.lastIndexOf('/'));
			// but when specifying a destination we use the native separator
			var path = [air.File.applicationStorageDirectory.nativePath,
						 gPageParams.name, end].join(air.File.separator);
			var title = end.slice(0, end.lastIndexOf('.'));
			var dst = new air.File(path);
			e.target.copyTo(dst, true);
			var m = {"title": title, "type": typeOfFile(path),
			                "path": relativize(path)};
			var newlink = appendItemToList(m, $('tbody.proj'));
			gManifest.push(m);
			saveManifest(gManifest, gPageParams.name);
			newlink.click();
			// the upload button is inside #dialog-add
			$('#dialog-add').dialog("close");
		});
	});

	$('#btnCreate').click(function() {
		var path = [air.File.applicationStorageDirectory.nativePath,
			gPageParams.name, 'file-' + Math.floor(Math.random()*4000000000) + '.txt'
		].join(air.File.separator);
		var f = new air.File(path);
		var fs = new air.FileStream();
		fs.open(f, air.FileMode.WRITE);
		fs.writeMultiByte('', "utf-8");
		fs.close();

		var m = {"title": "untitled", "type": "text", "path": relativize(path)};
		var newlink = appendItemToList(m, $('tbody.proj'));
		gManifest.push(m);
		saveManifest(gManifest, gPageParams.name);
		// the create text button is inside #dialog-add
		$('#dialog-add').dialog("close");
		newlink.find('a').click();
	});

	$('#btnQuiz').click(function() {
		$('form.quiz').toggle();
	});

	$('form.quiz').submit(function(event) {
		var quiztitle = $('form.quiz input[name="name"]').val();
		var quizdir   = new air.File(
			[air.File.applicationStorageDirectory.nativePath, gPageParams.name, quiztitle].join(air.File.separator));
		gManifest.push({
			"title": quiztitle,
			"path": relativize(quizdir.nativePath),
			"type": 'quiz'
		});
		saveManifest(gManifest, gPageParams.name);
		
		quizdir.createDirectory();
		var man = quizdir.resolvePath('manifest');
		var fs = new air.FileStream();
		fs.open(man, air.FileMode.WRITE);
		fs.writeMultiByte('', "utf-8");

		// change name field in form so the quiz page can parse it right
		var name = $(this).find('input[type="text"]').val();
		$(this).find('input[type="text"]').val(
			urlencode(gPageParams.name) + '/' + urlencode(name));

		return true;
	});

	function appendItemToList(m, list) {
		var tr = $('<tr />');
		// turn relative path in manifest into absolute path under the
		// application storage directory
		var path = air.File.applicationStorageDirectory.resolvePath(m.path).nativePath;

		if(m.type == 'unknown' || !iconForType(m.type)) {
			return;
		}
		tr.append($('<td class="icon"><img src="' + iconForType(m.type) + '"/></td>'));
		tr.append($('<td><a rel="' + m.type + '" href="' + path + '">' + m.title + '</a></td>'));
		tr.append($('<td>Unpublished</td>'));
		tr.append($('<td class="icon"><img class="remove" src="icons/remove.png" alt="Remove Item" /></td>'));
		list.append(tr);
		activateItemLinks(tr.find('a'));
		activateRemoveLinks(tr.find('img.remove'));
		return tr;
	}
});
</script>
</html>
