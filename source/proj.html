<html>
<head>
	<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.14.custom.css" rel="stylesheet" /> 
	<link type="text/css" href="css/screen.css" rel="stylesheet" />
	<link type="text/css" href="css/jquery.cleditor.css" rel="stylesheet" />
	<title>MASLO - Edit Project</title>
</head>
<body>
	<h1><a href="index.html">My Content Packs</a> > <span id="proj"></span></h1>
	<div class="extra"><a href="#">Help</a></div>
	<table>
	<thead>
		<tr>
			<th>Type</th>
			<th class="big">Title</th>
			<th class="big">Status</th>
			<th>Remove</th>
		</tr>
	</thead>
	<tbody class="proj">
	</tbody>
</table>

<div class="action">
	<a class="alt" href="">+ Add Content</a>
	<div class="alt">
		<input type="text" length="10" />
		<button type="button">OK</button>
		<button type="button" class="cancel">Cancel</button>
	</div>
	<button type="button">Publish</button>
	<button type="button" id="preview">Preview</button>
	<div class="clear"></div>
</div>

<!------------------- ######### DIALOGS --------------------- -->

<div id="dialog" style="display: none" title="Add Content">
	<table>
		<tbody>
			<tr>
				<td><input type="file" id="upload" style="display: none" />
					<!-- this button sends any click to the hidden
					     file input element -->
					<button onclick="$('#upload').click()">Upload</button></td>
				<td>
					<img src="icons/image.png" height="16" width="16"/>
					Image:&nbsp;png,&nbsp;jpg,&nbsp;gif,&nbsp;tiff<br />
					<img src="icons/audio.png" height="16" width="16"/>
					Audio:&nbsp;mp3,&nbsp;wav,&nbsp;aiff<br />
					<img src="icons/video.png" height="16" width="16"/>
					Video:&nbsp;mp4,&nbsp;avi,&nbsp;mov
				</td>
			</tr>
			<tr>
				<td><button id="btnCreate" type="button">Create Text</button></td>
				<td>
					<img src="icons/text.png" height="16" width="16"/>
					Write new, or copy and paste
				</td>
			</tr>
			<tr>
				<td><button id="btnQuiz" type="button">Create Quiz</button></td>
				<td>
					<img src="icons/quiz.png" height="16" width="16"/>
					Questions, answer, hints
				</td>
			</tr>
		</tbody>
	</table>
	<form class="quiz" style="display:none" action="quiz.html" method="GET">
		<input type="text" name="title" />
		<input type="hidden" name="proj" />
		<input type="submit" value="Create" disabled="disabled" />
	</form>
</div>

<div id="edit-content" style="display: none" title="Edit Content">
	<input type="text" size="55" class="title" />
	<div></div>
</div>

<div id="dialog-confirm" style="display: none" title="Delete Content">
	<p>This content will be permanently deleted and cannot be
	recovered. Are you sure?</p>
</div>

</body>

<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.watermark.min.js"></script>
<script type="text/javascript" src="js/jquery.cleditor.js"></script>
<script type="text/javascript" src="js/mpthrize.js"></script>
<script type="text/javascript" src="js/param.js"></script>
<script type="text/javascript" src="js/files.js"></script>
<script type="text/javascript" src="js/urldecode.js"></script>
<script type="text/javascript" src="js/manifest.js"></script>
<script type="text/javascript" src="AIRAliases.js"></script>
<script type="text/javascript">
var gPageParams = queryParameters(document.location.search);
var	gManifest = manifest(gPageParams.name);
var dlgCloseTrigger = function() {
	// when the edit content dialog is closed, clean it for the
	// next time, which may be a very different kind of content
	$('#edit-content div').empty();
};

$(document).ready(function() {
	$('#proj').text(gPageParams.name.toString());

	for(var m in gManifest) {
		m = gManifest[m];
		var tr = $('<tr />');
		// turn relative path in manifest into absolute path under the
		// application storage directory
		var path = air.File.applicationStorageDirectory.resolvePath(m.path).nativePath;

		if(m.type == 'unknown' || !iconForType(m.type)) {
			continue;
		}
		tr.append($('<td class="icon"><img src="' + iconForType(m.type) + '"/></td>'));
		tr.append($('<td><a rel="' + m.type + '" href="' + path + '">' + m.title + '</a></td>'));
		tr.append($('<td>Unpublished</td>'));
		tr.append($('<td class="icon"><img class="remove" src="icons/remove.png" alt="Remove Item" /></td>'));
		$('tbody.proj').append(tr);
	}

	$("tbody.proj").sortable({
		items: 'tr',
		axis: 'y',
		start: function(event, ui) {
			ui.item.data('start_pos', ui.item.index());
		},
		change: function(event, ui) {
			ui.item.data('end_pos', ui.placeholder.index());
		},
		update: function(event, ui) {
			var start_pos = ui.item.data('start_pos');
			var end_pos   = ui.item.data('end_pos');
			if(end_pos > start_pos) {
				end_pos--;
			}
			if(end_pos >= gManifest.length) {
				gManifest.push(undefined);
			}
			gManifest.splice(end_pos, 0, gManifest.splice(start_pos, 1)[0]);
			saveManifest();
		}
	});


	$('img.remove').click(function(e) {
		var elt = $(this).parent().parent();
		$( "#dialog-confirm" ).dialog({
			height:240,
			modal: true,
			buttons: {
				"Delete Content": function() {
					gManifest.splice(elt.index(), 1);
					air.trace(
						elt.find('a').attr('href')
					);
					var condemned = new air.File(
						elt.find('a').attr('href')
					);
					if(condemned.isDirectory) {
						comdemned.deleteDirectory(true);
					} else {
						condemned.deleteFile();
					}
					saveManifest();
					window.htmlLoader.reload();
				},
				Cancel: function() {
					$( this ).dialog( "close" );
				}
			}
		});
	});

	$('form.quiz input[type="text"]').watermark('Name of Quiz');
	$('form.quiz input[type="text"]').keyup(function() {
			$('form.quiz input[type="submit"]').attr('disabled',
				$(this).val() == '');
	});

	$('tbody a[rel]').click(function(e) {
		var pos = $(e.target).parent().parent().index();
		$('#edit-content input.title').val($(e.target).text());
		var contentDiv = $('#edit-content div');

		// first set up the edit-content dialog
		var textArea = $('<textarea rows="3" cols="50">temp</textarea>');

		if(e.target.rel == 'text') {
			textArea.val(loadTextfile($(e.target).attr('href')));
			contentDiv.append(textArea);
		} else if(e.target.rel == 'image') {
			var img = $('<img />')
			img.attr('src', 'file://' + $(e.target).attr('href'));
			contentDiv.append(img);
			contentDiv.append(textArea);
		} else if(e.target.rel == 'audio') {
			mpthrize(contentDiv, 'file://' + $(e.target).attr('href'))
			textArea.val(gManifest[pos].description);
			contentDiv.append(textArea);
		} else if(e.target.rel == 'quiz') {
			window.location = 'quiz.html?name=' +
				relativize($(e.target).attr('href'));
			return false;
		} else if(e.target.rel == 'video') {
			var options = new air.NativeWindowInitOptions(); 
			options.systemChrome = air.NativeWindowSystemChrome.STANDARD; 
			options.transparent = false; 
			var newWindow = new air.NativeWindow(options);
			newWindow.activate();
			var nc = new air.NetConnection()
			nc.connect(null);
			var ns = new air.NetStream(nc);
			ns.addEventListener(air.AsyncErrorEvent.ASYNC_ERROR, asyncError);
			function asyncError() { }
			ns.play('file://' + $(e.target).attr('href'));
			var vid = new air.Video();
			vid.attachNetStream(ns);
			newWindow.stage.addChild(vid);
		}

		// now show the dialog
		$('#edit-content').dialog({
			autoOpen: true,
			modal: true,
			width: 540,
			position: 'top',
			beforeClose: function() {
				/* inside to avoid being frozen in closure */
				dlgCloseTrigger();
			},
			buttons: {
				"Replace": function() { 
					var orig = new air.File($(e.target).attr('href'));
					chooseFile(function(f) {
					f.target.copyTo(orig, true);
					d = new Date();
					// reload image with cache-busting querystring
					$('#edit-content img')
						.attr('src', 'file://' + $(e.target).attr('href') +
						      '?' + d.getTime());
					});
				},
				"Save": function() { 
					if(e.target.rel == 'text') {
						var f = new air.File($(e.target).attr('href'));
						var fs = new air.FileStream();
						fs.open(f, air.FileMode.WRITE);
						fs.writeMultiByte($('#edit-content textarea').val(), "utf-8");
						fs.close();
					}
					var title = $('#edit-content input.title').val();
					var desc = $('#edit-content textarea').val();
					var modified = false;
					if(gManifest[pos].title != title ||
					   gManifest[pos].description != desc) {
						gManifest[pos].title = title;
						gManifest[pos].description = desc;
						modified = true;
					}
					$(this).dialog("close"); 
					if(modified) {
						saveManifest();
						window.htmlLoader.reload();
					}
				} 
			}
		});
		textArea.cleditor({
			controls: "bold italic underline bullets numbering alignleft " +
					  "center alignright justify undo redo cut copy paste"
		});

		return false;
	});

	$('#preview').click(function() {
		window.location = 'preview.html?name=' + gPageParams.name;
	});
	$('.action a.alt').click(function() {
		$('#dialog').dialog({
			autoOpen: true,
			modal: true,
			width: 450,
			position: 'top',
			buttons: {
				"Cancel": function() { 
					$(this).dialog("close"); 
				} 
			}
		});
		return false;
	});

	$('#upload').click(function() {
		chooseFile(function(e) {
			// we use a forward slash here rather than the native path separator
			// because it occurs in the url form of the filename
			var end = urldecode(e.target.url).slice(
				1 + e.target.url.lastIndexOf('/'));
			// but when specifying a destination we use the native separator
			var path = [air.File.applicationStorageDirectory.nativePath,
						 gPageParams.name, end].join(air.File.separator);
			var title = end.slice(0, end.lastIndexOf('.'));
			var dst = new air.File(path);
			e.target.copyTo(dst, true);
			gManifest.push({"title": title, "type": typeOfFile(path),
			                "path": relativize(path)});
			saveManifest();

			window.htmlLoader.reload();
		});
	});

	$('#btnCreate').click(function() {
		var path = [air.File.applicationStorageDirectory.nativePath,
			gPageParams.name, 'file-' + Math.floor(Math.random()*4000000000) + '.txt'
		].join(air.File.separator);
		var f = new air.File(path);
		var fs = new air.FileStream();
		fs.open(f, air.FileMode.WRITE);
		fs.writeMultiByte('', "utf-8");
		fs.close();

		gManifest.push({
			"title": 'untitled',
			"type": "text", "path": relativize(path)
		});
		saveManifest();
		window.htmlLoader.reload();
	});

	$('#btnQuiz').click(function() {
		$('form.quiz').toggle();
	});

	$('form.quiz').submit(function(event) {
		var quiztitle = $('form.quiz input[name="title"]').val();
		var quizdir   = new air.File(
			[air.File.applicationStorageDirectory.nativePath, gPageParams.name, quiztitle].join(air.File.separator));
		gManifest.push({
			"title": quiztitle,
			"path": relativize(quizdir.nativePath),
			"type": 'quiz'
		});
		saveManifest();
		
		quizdir.createDirectory();
		var man = quizdir.resolvePath('manifest');
		var fs = new air.FileStream();
		fs.open(man, air.FileMode.WRITE);
		fs.writeMultiByte('', "utf-8");
		$(event.target).children('input[name="proj"]').val(gPageParams.name);
		return true;
	});

	function saveManifest() {
		var f = new air.File(
			[air.File.applicationStorageDirectory.nativePath, gPageParams.name, 'manifest']
			.join(air.File.separator)
		);
		var fs = new air.FileStream();
		fs.open(f, air.FileMode.WRITE);
		fs.writeMultiByte(JSON.stringify(gManifest), "utf-8");
		fs.close();
	}


});
</script>
</html>
