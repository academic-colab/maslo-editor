<html>
<head>
	<link type="text/css" href="css/foundation.css" rel="stylesheet" />
	<link type="text/css" href="css/screen.css" rel="stylesheet" />
	<link type="text/css" href="css/jquery.selectBox.css" rel="stylesheet" />
	<title>MASLO - Preview</title>
</head>
<body>
	<header>
	<h3><a href="index.html">My Content Packs</a> >
		<a class="back" href="">hello</a> > Preview</h3>
	<div class="extra"><a href="#" onclick="help()">Help</a><img src="icons/maslo_icon_logo.png" /></div>
	</header>

	<div id="focus">
		<div class="nav">
			<h2>Table of Contents</h2>
			<select size="10" class="toc">
			</select>
			<div class="flippers">
				<a class="vertical active" href=""></a>
				<a class="horizontal" href=""></a>
			</div>
		</div>

		<div class="phone">
			<div class="viewport">
				<div class="canvas">
					<ul class="data"></ul>
				</div>
			</div>
		</div>

		<div class="movement">
			<a href="#" class="move left"></a>
			<a href="#" class="move right"></a>
		</div>

	</div>

	<div class="action bottom">
		<button class="nice small radius blue button" type="button">Publish</button>
		<button class="nice small radius blue button" id="back" type="button">Back</button>
		<div class="clear"></div>
	</div>


<script type="text/javascript" src="AIRAliases.js"></script>
<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
<script type="text/javascript" src="js/jquery.selectBox.min.js"></script>
<script type="text/javascript" src="js/jquery.scroll.js"></script>
<script type="text/javascript" src="js/mpthrize.js"></script>
<script type="text/javascript" src="js/param.js"></script>
<script type="text/javascript" src="js/files.js"></script>
<script type="text/javascript" src="js/types.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script type="text/javascript" src="js/help.js"></script>
<script type="text/javascript" src="js/manifest.js"></script>
<script type="text/javascript">

// this will be called on page turn, and will be used to stop
// audio that might have been playing in a page.
var gSwitchHandler = function() {};

// -------------------------- SET UP PAGE -------------------------
$(document).ready(function() {
	var gPageParams = queryParameters(document.location.search);
	$('a.back').attr('href', 'proj.html?name=' + gPageParams.name);
	$('a.back').text(gPageParams.name.toString());
	$('#back').click(function() {
		window.location = 'proj.html?name=' + gPageParams.name;
	});

	var gManifest = manifest(gPageParams.name);
	// the visible TOC ui
	var s = $('select');
	// the hidden source of actual data
	var d = $('ul.data');
	for(var m in gManifest) {
		m = gManifest[m];
		s.append("<option>" + m.title + "</option>");
		var path = air.File.applicationStorageDirectory.resolvePath(m.path).nativePath;
		var li = $('<li style="display:none"></li>');
		if(m.type == 'text') {
			li.append('<span>' + loadTextfile(path) + '</span>');
		} else if(m.type == 'image') {
			li.append(['<img src=', 'file://' + path, '/>'].join('"'));
		} else if(m.type == 'audio') {
			// save the STOP AUDIO function
			gSwitchHandler = mpthrize(li, 'file://' + path);
		} else if(m.type == 'quiz') {
			var q = manifest(m.path);
			presentQuestion(q, 0, li);
		}
		if(m.description) {
			li.append('<p>' + m.description + '</p>');
		}
		d.append(li);
	}


// ----------------------- LOAD FIRST PAGE INTO PHONE ----------------------
	$('div.canvas > ul li:eq(0)').toggle();
	$("select option:first").attr('selected','selected');
	

// -------------------------- SET UP CLICK HANDLER -------------------------
	$("select").selectBox().change( function() {
		gSwitchHandler();
		$('div.canvas > ul > li').hide();
		$('div.canvas > ul > li:eq(' + this.selectedIndex + ')').show();
	});

	$('div.flippers a.horizontal').click(function() {
			$('div.flippers a.horizontal').addClass('active');
			$('div.flippers a.vertical').removeClass('active');
			$('.phone').addClass('horizontal');
			return false;
	});

	$('div.flippers a.vertical').click(function() {
			$('div.flippers a.horizontal').removeClass('active');
			$('div.flippers a.vertical').addClass('active');
			$('.phone').removeClass('horizontal');
			return false;
	});


	$('div.movement a.move.left').click(function() {
		var v = $('select').find('OPTION:selected').prev().val();
		if(v) {
			s.selectBox('value', v).change();
		}
		return false;
	});
	$('div.movement a.move.right').click(function() {
		var v = $('select').find('OPTION:selected').next().val();
		if(v) {
			s.selectBox('value', v).change();
		}
		return false;
	});


	function presentQuestion(questions, index, canvas) {
		canvas.empty();
		canvas.append('<p>' + questions[index].question + '</p>');
		for(var i in questions[index].answers) {
			canvas.append('<input name="answer" value="' + i + '" type="radio" />');
			canvas.append(questions[index].answers[i].text + '<br />');
		}

		// next is called both directly and in case of
		// existing feedback in a click callback
		var next = function() {
			if(index+1 >= questions.length) {
				canvas.empty();
				canvas.append('<p>End of quiz.</p>');
				var reset = $('<button class="nice small radius black button">Retry quiz</button>');
				reset.click(function() {
					presentQuestion(questions, 0, canvas);
				});
				canvas.append(reset);
			} else {
				presentQuestion(questions, index+1, canvas);
			}
		};
		var submit = $('<button class="nice small radius black button" >Submit</button>');
		submit.click(function() {
			var i = $('input[name=answer]:checked').val();
			// feedback is blank when no selection is made
			// or when there simply is no feedback for a selection
			var feedback = i === undefined
				? '' : questions[index].answers[i].feedback;
			if(feedback) {
				canvas.empty();
				canvas.append('<p>' + feedback + '</p>');

				// We are reusing this button as the continue button
				// for the feedback screen. The whole screen is erased
				// next time so it will reset to Submit.
				submit.click(next);
				submit.text('Continue');
				canvas.append(submit);
			} else {
				next();
			}
		});
		canvas.append(submit);
	}

});
</script>
</body>
</html>
